<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notas Uni ‚Äî 100% HTML</title>
  <style>
   body {
  background: #008080; /* verde azulado cl√°sico Win95 */
  font-family: "MS Sans Serif", Tahoma, sans-serif;
  font-size: 14px;
  margin: 0;
  padding: 10px;
  color: black;
}

.app {
  display: grid;
  grid-template-columns: 220px 280px 1fr;
  gap: 8px;
  width: 100%;
  height: 100vh;
}

.panel {
  background: #c0c0c0;
  border: 2px solid #fff;
  border-right-color: #808080;
  border-bottom-color: #808080;
  display: flex;
  flex-direction: column;
}

.header {
  background: navy;
  color: white;
  padding: 3px 6px;
  font-weight: bold;
  font-size: 13px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

h1 {
  margin: 0;
  font-size: 14px;
  font-weight: bold;
}

.btn {
  font-family: "MS Sans Serif", Tahoma;
  font-size: 13px;
  padding: 2px 8px;
  background: #c0c0c0;
  border: 2px solid #fff;
  border-right-color: #808080;
  border-bottom-color: #808080;
  cursor: pointer;
}

.btn:active {
  border: 2px solid #808080;
  border-right-color: #fff;
  border-bottom-color: #fff;
}

.field {
  font-family: "MS Sans Serif", Tahoma;
  border: 2px solid #808080;
  background: white;
  padding: 3px;
  width: 100%;
  box-sizing: border-box;
}

.list {
  flex: 1;
  overflow-y: auto;
  padding: 4px;
}

.item {
  padding: 4px;
  margin: 2px 0;
  border: 1px solid transparent;
  cursor: pointer;
}

.item:hover {
  background: #00008022;
  border: 1px solid #000080;
}

.item.active {
  background: #00008044;
  border: 1px solid navy;
}

.editor {
  flex: 1;
  background: white;
  border: 2px inset #808080;
  padding: 6px;
  overflow-y: auto;
  min-height: 200px;
}

.toolbar {
  background: #c0c0c0;
  border-bottom: 2px solid #808080;
  padding: 2px;
  display: flex;
  gap: 4px;
}

.tool {
  font-size: 12px;
  padding: 2px 6px;
  background: #c0c0c0;
  border: 2px solid #fff;
  border-right-color: #808080;
  border-bottom-color: #808080;
  cursor: pointer;
}

.tool:active {
  border: 2px solid #808080;
  border-right-color: #fff;
  border-bottom-color: #fff;
}

.footer {
  font-size: 12px;
  padding: 3px 6px;
  background: #c0c0c0;
  border-top: 2px solid #fff;
  border-left: 2px solid #fff;
  border-right: 2px solid #808080;
  border-bottom: 2px solid #808080;
  color: black;
}

  </style>
</head>
<body>
  <div class="app">

    <!-- Cursos -->
    <section class="panel" id="coursesPanel">
      <div class="header">
        <h1>üìö Cursos</h1>
        <div class="row">
          <button class="btn" id="addCourseBtn">+ Curso</button>
          <button class="btn ghost" id="importBtn">Importar</button>
          <button class="btn ghost" id="exportBtn">Exportar</button>
        </div>
      </div>
      <div style="padding:8px">
        <input class="field" id="courseSearch" placeholder="Buscar curso..." />
      </div>
      <div class="list" id="courseList"></div>
      <div class="footer"><span class="hint">Doble clic para renombrar</span><span id="courseCount" class="hint"></span></div>
    </section>

    <!-- Notas del curso -->
    <section class="panel" id="notesPanel">
      <div class="header">
        <h1>üìù Notas</h1>
        <div class="row">
          <button class="btn" id="addNoteBtn">+ Nota</button>
          <button class="btn danger" id="deleteNoteBtn">Eliminar</button>
        </div>
      </div>
      <div style="padding:8px">
        <input class="field" id="noteSearch" placeholder="Buscar nota en el curso..." />
      </div>
      <div class="list" id="noteList"></div>
      <div class="footer"><span id="noteCount" class="hint"></span><span class="hint">Selecciona una nota para editar</span></div>
    </section>

    <!-- Editor -->
    <section class="panel" id="editorPanel">
      <div class="header">
        <div>
          <h1 id="currentNoteTitle">Sin t√≠tulo</h1>
          <div class="hint" id="currentCourseName">‚Äî</div>
        </div>
        <div class="row">
          <span class="badge" id="lastSaved">Guardado ‚Ä¢ ‚Äî</span>
          <button class="btn primary" id="downloadHtmlBtn">Descargar HTML</button>
        </div>
      </div>

      <div class="toolbar">
        <button class="tool" data-cmd="bold"><b>B</b></button>
        <button class="tool" data-cmd="italic"><i>I</i></button>
        <button class="tool" data-cmd="underline"><u>U</u></button>
        <button class="tool" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
        <button class="tool" data-cmd="insertOrderedList">1. Lista</button>
        <button class="tool" id="h2Btn">H2</button>
        <button class="tool" id="linkBtn">üîó Enlace</button>
        <button class="tool" id="clearBtn">Limpiar formato</button>
      </div>

      <div class="meta">
        <span class="pill" id="wordCount">0 palabras</span>
        <span class="pill" id="charCount">0 caracteres</span>
        <span class="pill" id="readingTime">0 min lectura</span>
      </div>

      <div id="editor" class="editor" contenteditable="true" data-placeholder="Escribe aqu√≠... Usa la barra de herramientas para dar formato e insertar enlaces."></div>

      <div class="footer">
        <span class="hint">Consejo: selecciona texto y pulsa üîó para crear un enlace.</span>
        <span class="hint" id="status">Listo</span>
      </div>
    </section>
  </div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />

  <script>
  // --- Utilidades ---
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const uid = () => crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);
  const nowISO = () => new Date().toISOString();
  const formatDate = iso => new Date(iso).toLocaleString();

  const STORAGE_KEY = 'notasUni.v1';

  const blankState = () => ({
    courses: [
      { id: uid(), name: 'Ejemplo: Matem√°ticas', notes: [
        { id: uid(), title: 'Clase 1 ‚Äî L√≠mites', html: '<h2>Introducci√≥n</h2><p>Definici√≥n de l√≠mite...</p><p>Recurso: <a href="https://es.khanacademy.org/math" target="_blank">Khan Academy</a></p>', updatedAt: nowISO() }
      ] }
    ],
    selectedCourseId: null,
    selectedNoteId: null
  });

  let state = load();
  if(!state){ state = blankState(); save(); }
  if(!state.selectedCourseId && state.courses[0]) state.selectedCourseId = state.courses[0].id;
  if(!state.selectedNoteId && state.courses[0]?.notes[0]) state.selectedNoteId = state.courses[0].notes[0].id;

  // --- Persistencia ---
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    $('#lastSaved').textContent = 'Guardado ‚Ä¢ ' + formatDate(nowISO());
  }
  function load(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null }
  }

  // --- Render ---
  function renderCourses(){
    const q = $('#courseSearch').value.toLowerCase();
    const list = $('#courseList'); list.innerHTML = '';
    state.courses
      .filter(c => c.name.toLowerCase().includes(q))
      .forEach(c => {
        const el = document.createElement('div');
        el.className = 'item' + (c.id===state.selectedCourseId ? ' active' : '');
        el.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
          <div>
            <strong>${escapeHtml(c.name)}</strong>
            <small>${c.notes.length} nota(s)</small>
          </div>
          <div class="row">
            <button class="btn ghost" data-act="rename" data-id="${c.id}">Renombrar</button>
            <button class="btn danger" data-act="delete" data-id="${c.id}">√ó</button>
          </div>
        </div>`;
        el.addEventListener('click', e => { if(e.target.closest('button')) return; state.selectedCourseId = c.id; state.selectedNoteId = c.notes[0]?.id || null; save(); renderAll(); });
        list.appendChild(el);
      });
    $('#courseCount').textContent = `${state.courses.length} curso(s)`;
  }

  function renderNotes(){
    const course = getCurrentCourse();
    const q = $('#noteSearch').value.toLowerCase();
    const list = $('#noteList'); list.innerHTML = '';
    let notes = course ? course.notes : [];
    notes = notes.filter(n => (n.title+stripHtml(n.html)).toLowerCase().includes(q));
    notes.forEach(n => {
      const el = document.createElement('div');
      el.className = 'item' + (n.id===state.selectedNoteId ? ' active' : '');
      el.innerHTML = `<strong>${escapeHtml(n.title || 'Sin t√≠tulo')}</strong>
                      <small>Actualizado: ${formatDate(n.updatedAt)}</small>`;
      el.addEventListener('click', ()=>{ state.selectedNoteId = n.id; save(); renderEditor(); renderNotes(); });
      list.appendChild(el);
    });
    $('#noteCount').textContent = `${notes.length} nota(s)`;
  }

  function renderEditor(){
    const course = getCurrentCourse();
    const note = getCurrentNote();
    $('#currentCourseName').textContent = course ? course.name : '‚Äî';
    $('#currentNoteTitle').textContent = note ? (note.title || 'Sin t√≠tulo') : 'Sin t√≠tulo';
    $('#editor').innerHTML = note ? note.html : '';
    updateStats();
  }

  function renderAll(){ renderCourses(); renderNotes(); renderEditor(); }

  function getCurrentCourse(){ return state.courses.find(c=>c.id===state.selectedCourseId) || state.courses[0] || null }
  function getCurrentNote(){ const c = getCurrentCourse(); return c ? (c.notes.find(n=>n.id===state.selectedNoteId) || c.notes[0] || null) : null }

  // --- Acciones Cursos ---
  $('#addCourseBtn').addEventListener('click', ()=>{
    const name = prompt('Nombre del curso:');
    if(!name) return;
    state.courses.push({id: uid(), name: name.trim(), notes: []});
    state.selectedCourseId = state.courses[state.courses.length-1].id;
    state.selectedNoteId = null;
    save(); renderAll();
  });

  $('#courseList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id;
    const course = state.courses.find(c=>c.id===id);
    if(btn.dataset.act==='rename'){
      const name = prompt('Nuevo nombre del curso:', course.name);
      if(name){ course.name = name.trim(); save(); renderCourses(); renderEditor(); }
    }
    if(btn.dataset.act==='delete'){
      if(!confirm('¬øEliminar curso y todas sus notas?')) return;
      state.courses = state.courses.filter(c=>c.id!==id);
      if(state.selectedCourseId===id){ state.selectedCourseId = state.courses[0]?.id || null; state.selectedNoteId = null; }
      save(); renderAll();
    }
  });

  $('#courseSearch').addEventListener('input', renderCourses);

  // --- Acciones Notas ---
  $('#addNoteBtn').addEventListener('click', ()=>{
    const c = getCurrentCourse(); if(!c){ alert('Crea un curso primero'); return; }
    const title = prompt('T√≠tulo de la nota:','Nueva nota');
    const note = { id: uid(), title: (title||'Nueva nota').trim(), html: '', updatedAt: nowISO() };
    c.notes.unshift(note);
    state.selectedNoteId = note.id;
    save(); renderNotes(); renderEditor();
  });

  $('#deleteNoteBtn').addEventListener('click', ()=>{
    const c = getCurrentCourse(); const n = getCurrentNote();
    if(!c || !n) return;
    if(!confirm('¬øEliminar esta nota?')) return;
    c.notes = c.notes.filter(x=>x.id!==n.id);
    state.selectedNoteId = c.notes[0]?.id || null;
    save(); renderNotes(); renderEditor();
  });

  $('#noteSearch').addEventListener('input', renderNotes);

  // --- Editor y formateo ---
  $$('.tool[data-cmd]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.execCommand(btn.dataset.cmd, false, null);
      focusEditor();
      saveCurrentHtml();
    });
  });

  $('#h2Btn').addEventListener('click', ()=>{
    document.execCommand('formatBlock', false, 'h2');
    focusEditor(); saveCurrentHtml();
  });

  $('#clearBtn').addEventListener('click', ()=>{
    const el = document.createElement('div');
    el.innerText = stripHtml($('#editor').innerHTML);
    $('#editor').innerHTML = el.innerHTML; // texto plano
    saveCurrentHtml();
  });

  $('#linkBtn').addEventListener('click', ()=>{
    const url = prompt('Pega el enlace (incluye https://):');
    if(url){ document.execCommand('createLink', false, url); saveCurrentHtml(); }
  });

  $('#editor').addEventListener('input', ()=>{ saveCurrentHtml(); updateStats(); });

  function saveCurrentHtml(){
    const c = getCurrentCourse(); const n = getCurrentNote(); if(!c||!n) return;
    n.html = sanitizeHtml($('#editor').innerHTML);
    n.updatedAt = nowISO();
    save(); renderNotes();
  }

  function focusEditor(){ $('#editor').focus(); }

  function updateStats(){
    const text = stripHtml($('#editor').innerHTML);
    const words = (text.trim().match(/\b\w+\b/g) || []).length;
    const chars = text.length;
    const mins = Math.max(1, Math.round(words/200));
    $('#wordCount').textContent = words + ' palabras';
    $('#charCount').textContent = chars + ' caracteres';
    $('#readingTime').textContent = mins + ' min lectura';
  }

  // --- Exportar/Importar ---
  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'notas-uni.json';
    a.click();
  });

  $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
  $('#importFile').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        if(!obj.courses) throw new Error('Archivo inv√°lido');
        state = obj; save(); renderAll(); alert('Importado con √©xito');
      }catch(err){ alert('No se pudo importar: '+err.message); }
    };
    reader.readAsText(file);
  });

  // --- Descargar solo la nota actual como HTML aut√≥nomo ---
  $('#downloadHtmlBtn').addEventListener('click', ()=>{
    const note = getCurrentNote(); if(!note){ alert('No hay nota seleccionada'); return; }
    const html = `<!doctype html><html lang="es"><meta charset="utf-8"><title>${escapeHtml(note.title)}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1"><style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;line-height:1.6;max-width:900px;margin:40px auto;padding:0 16px;color:#0f172a}
        h1,h2,h3{line-height:1.25}
        a{color:#0369a1}
        .meta{color:#64748b;font-size:14px;margin-bottom:16px}
        .card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:18px}
      </style>
      <body>
        <h1>${escapeHtml(note.title)}</h1>
        <div class="meta">Exportado ${new Date().toLocaleString()}</div>
        <div class="card">${note.html}</div>
      </body></html>`;
    const blob = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (note.title||'nota')+'.html';
    a.click();
  });

  // --- Helpers de seguridad b√°sicos ---
  function escapeHtml(str=''){
    return str.replace(/[&<>"] /g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',' ':' '}[s]));
  }
  function stripHtml(html=''){ const div = document.createElement('div'); div.innerHTML = html; return (div.textContent||'').replace(/\s+/g,' ').trim(); }
  function sanitizeHtml(html=''){
    // Permitir solo etiquetas seguras b√°sicas
    const allowed = ['A','B','I','U','STRONG','EM','P','UL','OL','LI','H1','H2','H3','H4','H5','H6','BR','CODE','PRE'];
    const div = document.createElement('div'); div.innerHTML = html;
    const walker = document.createTreeWalker(div, NodeFilter.SHOW_ELEMENT, null);
    const toRemove = [];
    while(walker.nextNode()){
      const el = walker.currentNode;
      if(!allowed.includes(el.tagName)) toRemove.push(el);
      if(el.tagName==='A'){
        const href = el.getAttribute('href')||'';
        if(!/^https?:\/\//i.test(href)) el.removeAttribute('href');
        el.setAttribute('target','_blank');
        el.setAttribute('rel','noopener');
      } else {
        el.removeAttribute('style'); el.removeAttribute('onclick'); el.removeAttribute('onerror');
      }
    }
    toRemove.forEach(e=> e.replaceWith(document.createTextNode(e.textContent||'')));
    return div.innerHTML;
  }

  // --- Init ---
  renderAll();

  // Accesos r√°pidos
  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveCurrentHtml(); }
    if(e.ctrlKey && e.key.toLowerCase()==='b'){ e.preventDefault(); document.execCommand('bold'); saveCurrentHtml(); }
    if(e.ctrlKey && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#linkBtn').click(); }
  });
  </script>
</body>
</html>

